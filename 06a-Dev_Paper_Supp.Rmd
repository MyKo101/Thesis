
# Development and External Validation of a Multi-State Clinical Prediction Model for Chronic Kidney Disease Patients Progressing onto Renal Replacement Therapy and Death - Supplementary Material{#chap-dev-paper-supp}

## Statistical Analysis

### Development

Data was recorded in a time-updated manner, however all variables were measured at baseline to emulate the real-world application of the model (i.e. future prediction of states and not covariates). Variables considered as covariates were demographics (sex, age, smoking status and alcohol consumption), comorbidities (congestive cardiac failure (CCF), chronic obstructive pulmonary disease (COPD), prior  cerebrovascular accident (CVA), hypertension (HT), diabetes mellitus (DM), ischemic heart disease (IHD), chronic liver disease (LD), prior myocardial infarction (MI), peripheral vascular disease (PVD) and slid tumour (ST)), physical parameters (BMI, blood pressure), blood results (haemoglobin, albumin, corrected calcium and phosphate measures), urine protein creatinine ratio (uPCR) and primary renal diagnosis (grouped as per ERA-EDTA classifications [@venkat-raman_new_2012]). Ethnicity was assessed in the populations, but as most patients were white, it was omitted as a potential predictor from the models.

uPCR and eGFR Rate of change were also calculated [@kovesdy_past_2016; @naimark_past_2016]  as the difference between the two most recent measures divided by time difference in years. $\textrm{Age}^2$, log(Age), log(eGFR Rate) and log(uPCR Rate) were considered as transformations within the model. log(Calendar Time) was included as a covariate to adjust for time trends in treatment preferences `r cc("Something")`. Calendar Time was defined as length of time between start date and  1st January 2019. `r xx("Matt mentioned the use of log Calendar Time rather than simply Calendar Time. I read this a while ago and can't currently locate the paper (I believe it was a simulation study). I'll carry on looking for it though of course")`

Intermediate states (RRT or modality) were considered to be medically transformative, and so a semi-markov (clock reset) method for analysis was considered to be well justified [@meira-machado_multi-state_2009]. Each transition was modelled under a proportional hazards assumption using the Royston-Parmar technique [@royston_flexible_2002] to estimate coefficients for each covariate and a restricted cubic spline (on the log-time scale) for the baseline cumulative hazard. The cumulative hazards for each transition can be combined to produce estimates for the probability of a patient being in any state at any time [@putter_tutorial_2007].

For variable selection, we stacked the imputed datasets together to create a larger, pseudo-population [@wood_how_2008] and performed backwards-forwards selection based on minimising the AIC at each step. This was repeated for each transition and for different numbers of evenly spaced knots in modelling the form of the baseline hazard, K={0,1,2,3,4,5}. This allowed for different transitions to use different sets of variables and numbers of knots in the final model. Some combinations of variables resulted in models that were intractable and so these models were excluded. Once a set of variables were chosen, the R-P model was applied to each imputed dataset individually and the resulting coefficients and cubic spline parameters were aggregated across imputations using Rubin's Rules [@rubin_multiple_1984]. This gave a model fully defined by smooth cubic splines representing the cumulative cause-specific hazard and individualised proportional hazards for each transition.

All missing data were assumed to be missing at random and so were multiply imputed using chained equations with the Nelson-Aalen estimators for each relevant transition as predictors [@white_imputing_2009]. Some variables (smoking status and histories of COPD, LD and ST)  were present in the SKS (development) dataset, but were completely missing in the SERPR extract (validation) and so these were multiply imputed from the development dataset [@janssen_dealing_2009].

### Validation

Further to the simple individual validation performed above. A statistical validation will need to be performed to formally establish the performance of the models.

Each of the three models were internally validated in the development dataset using bootstrapping to adjust for optimism and then further externally validated in the validation dataset extracted from SERPR[@schomaker_bootstrap_2018]. The bootstrapping method was also used for both validations to produce confidence intervals around the performance metric estimates.. To assess the performance in low eGFR patients, the models were also validated in subsets of the SKS and SERPR where patients had an $\textrm{eGFR} < 30\textrm{ml}/\textrm{min}/1.73\textrm{m}^2$.

For validation purposes, we consider Death and Death after RRT/HD/PD to be distinct states meaning that for the Three-State model, we have $K=4$ pathways a patient can take and for the Five-State model, we have $K=7$. To compare across models, we combined states together to collapse down to simpler versions. We collapsed the Three-State model to a two-state structure by combining the CKD and RRT states into an Alive state. We collapsed the Five-State model to a three-state structure by combining the HD, PD and Tx into an RRT state and then further down to a two-state structure as with the Three-State model. We will report performance measures at 360 days (approx. 1-year), 720 days (approx. 2-years) and 1800 days (approx. 5-years). As well as presenting the performance measures over time.

The performance metrics were chosen from those defined in chapter {#chap-performance-metrics}.

The overall accuracy of each model was assessed using the MSM adjusted Brier Scoreas defined in , which is a proper score function assigning 0 to a non-informative model and 1 to a perfect model, with negative numbers implying the model performs worse than assuming every patient's state predictions are the same as the overall prevalence within the population.

The discrimination of each model was assessed using the MSM extension to the c-statistic [@calster_extending_2012-1]. The c-statistic is a score between 0 and 1 with higher scores suggesting a better model and a c-statistic of 0.5 suggesting the model performs no better than a non-informative model.

The calibration of each model was assessed using MSM multinomial logistic regression (MLR)  [@hoorde_assessing_2014] which extends the logistic regression to three or more mutually exclusive outcomes [@riley_prognosis_2019]. This produces an intercept vector of length $K-1$ and a Slope-matrix of dimension $(K-1) \times (K-1)$. As with the traditional calibration intercept for a well performing model, the MLR intercept values should all be as close to 0 as possible.  The traditional calibration slope should be as close to 1 as possible and so the multi-state extension of the slope, the Slope-matrix should be as close to the identity matrix ($I$) as possible.

## Model Results

```{r print_table_PH_function, include=F}
print_table_PH <- function(fn,Model,lscape=F,scroll_width=F)
{
  sModel <- recode(Model,`2`="Two",`3`="Three",`5`="Five")
  nTrans <- case_when(Model == 2 ~ 1,Model==3~3,Model==5~6)
  algn <- paste0(rep("r",nTrans),collapse="")
  paste0(.wd,fn) %>%
    read_csv(col_types=cols()) %>%
    select(Var,starts_with(paste0("Trans_",Model)))%>%
    Dev_Valid_Paper_Var_Names(Var,group_var=".group")%>%
    to_kable(col_names=Trans_short2long,
             row_names="Var",
             align=algn,
             numeric_cols=1:nTrans+1,
             group_col = ".group",
             caption=paste0("Proportional Hazards for each transition in the ",
                         sModel,"-State Model"),
             lscape=lscape,
             col_widths=fb(c("4.1cm",rep("4.5cm",nTrans)),
                           c("4.0cm",rep("4.0cm",nTrans)),
                           c("4.0cm",rep("4.0cm",nTrans))))
  
}
```

```{r print_Cum_Haz_eq_function, include=F}
print_Cum_Haz_eq <- function(fn,Model)
{
  sModel <- recode(Model,`2`="Two",`3`="Three",`5`="Five")
nTrans <- case_when(Model == 2 ~ 1,Model==3~3,Model==5~6)
paste0(.wd,fn) %>%
  read_csv(col_types=cols()) %>% 
  filter(Model == sModel) %>%
  mutate(L0 = gsub("exp(case_when(","",L0,fixed=T),
         L0 = strsplit(L0,"\n\t\t"),
         L0 = map(L0,~tibble(haz = .,rn=1:length(.)))) %>%
  unnest(L0) %>%
  separate(haz,into=c("Range","Equation"),sep="~") %>%
  mutate(Transition = paste0(From," to ",To),
         Range = gsub("t & t","t",Range),
         Equation = gsub(",","",Equation,fixed=T),
         From = recode(From,Alive=1,CKD=1,HD=2,PD=3,Tx=4,RRT=5,Dead=6),
         To = recode(To,Alive=1,CKD=1,HD=2,PD=3,Tx=4,RRT=5,Dead=6)) %>%
  group_by(Transition,From,To) %>%
  arrange(Transition,rn) %>%
  mutate(L0 = paste0(Equation," & ",Range)) %>%
  summarise(L0 = paste0(L0,collapse="\\\\")) %>%
  mutate(L0 = paste0("\\begin{equation}\n\\Lambda_{0,",From,To,"}(t)=",
                     "\\begin{cases}",L0,
                     "(\\#eq:CH-",sModel,"-",From,To,")",
                     "\\end{cases}\n\\end{equation}"),
         L0 = gsub("log","\\log",L0,fixed=T),
         L0 = gsub("*","",L0,fixed=T),
         L0 = gsub("<=","\\le",L0,fixed=T)) %>%
  ungroup %>%
  pull(L0) %>%
  paste0(collapse="\n")
}
```

```{r list_table_Valid_function, include=F}
list_table_Valid <- function(fn,Model,external)
{
  sModel <- recode(Model,`2`="Two",`3`="Three",`5`="Five")
  nTrans <- case_when(Model == 2 ~ 1,Model==3~3,Model==5~6)
  
  cap <- paste0(if_else(external,"External","Internal"),
                " Validation of the ",
                sModel,"-State Model, results presented as Estimate (95% CI, where possible)")
  
  .mid <- paste0(.wd,fn) %>%
    read_csv(col_types=cols()) %>%
    filter(Model == sModel,src == ifelse(external,"UoG","SKS")) %>%
    select(-Model,-src) %>%
    arrange(Measure,Collapsed) %>%
    rename_at(vars(ends_with("Year")),
              ~gsub("_"," ",.,fixed=T)%>%
                trimws) %>%
    rename(Predicting=Collapsed,
           Average = Overall)
  
  
  .out <- .mid %>%
    filter(!(Predicting == "Five" & Measure == "Slope")) %>%
    to_kable(caption=cap,group_col="Measure",align="lrrrr",numeric_cols=2:5)
  
  
  
  if(Model == 5)
  {
    cap <- paste0("Calibration Slope results for the ",
                  if_else(external,"External","Internal"),
                  " Validation of the ",
                  "Five-State Model, results presented as Estimate (95% CI)")
    
    
    diag_pre <- matrix("",nrow=6,ncol=6)
    diag(diag_pre) <- "**"
    diag_post <- matrix("",nrow=6,ncol=6)
    diag(diag_post) <- "**"
    
    .out2 <- .mid %>%
      filter(Predicting == "Five" & Measure == "Slope") %>%
      pivot_longer(c(-Predicting,-Measure),names_to="Time",values_to="Slope") %>%
      select(-Measure,-Predicting) #%>%
      #to_kable(caption=cap,
      #         row_names = "Time",align="r",numeric_cols=1)
    
    
  } else .out2 <- ""
  
  list(.out,.out2)
  
}


```


`r xx("Describe the model results briefly")`

### Two State Model


Table \@ref(tab:PH-Two) shows the proportional hazard ratios for the transitions in the Two-State Model.


```{r PH-Two,echo=F}
print_table_PH("data/Dev_Paper_Hazard_Ratios.csv",2,lscape=F)
```

Equation \@ref(eq:CH-Two-16) below shows the hazard functions for the transition from Alive to Dead in the Two-State Model.

`r print_Cum_Haz_eq("data/Dev_Paper_Baseline_Cumulative_Hazard.csv",2)`

Table \@ref(tab:IV-Two) shows the results from the internal validation in the Two-State Model.


```{r IV-Two,echo=F}
res <- list_table_Valid("data/Dev_Paper_Validation.csv",2,F)
res[[1]]
```

Table \@ref(tab:EV-Two) shows the results from the external validation in the Two-State Model.


```{r EV-Two,echo=F}
res <- list_table_Valid("data/Dev_Paper_Validation.csv",2,T)
res[[1]]
```

### Three State Model

In the Three-State Model, older patients are predicted to be likely to transition to RRT. Increased rates of decline of eGFR were associated with the transition from CKD to RRT. The full results are shown in table \@ref(tab:PH-Three).

```{r PH-Three,echo=F}
print_table_PH("data/Dev_Paper_Hazard_Ratios.csv",3,lscape=T)
```


Female patients are predicted to be more likely to remain in the CKD state than Males, or to remain in the RRT state once there. Smokers were predicted as more likely than Non-/Former Smokers to undergo any transition, apart from CKD to Tx. Blood results had associations with all transitions in some way, and disease etiology were strongly associated with the transitions giving a wide range of predictions.

Equation \@ref(eq:CH-Three-16) shows the equation for 

The equations in \@ref(eq:Cum-Haz-Three) shows the hazard functions for the transition from CKD to Dead in the Three-State Model.

`r print_Cum_Haz_eq("data/Dev_Paper_Baseline_Cumulative_Hazard.csv",3)`

Table \@ref(tab:IV-Three) shows the results from the internal validation in the Three-State Model.

```{r IV-Three,echo=F}
res <- list_table_Valid("data/Dev_Paper_Validation.csv",3,F)
res[[1]]
```

Table \@ref(tab:EV-Three) shows the results from the external validation in the Three-State Model.


```{r EV-Three,echo=F}
res <- list_table_Valid("data/Dev_Paper_Validation.csv",3,T)
res[[1]]
```

### Five State Model

Table \@ref(tab:PH-Five) shows the proportional hazard ratios for the transitions in the Five-State Model.

```{r PH-Five,echo=F}
print_table_PH("data/Dev_Paper_Hazard_Ratios.csv",5,lscape=T,scroll_width=T)
```

The equations in \@ref(eq:Cum-Haz-Five) shows the hazard functions for the transitions in the Five-State Model.

`r print_Cum_Haz_eq("data/Dev_Paper_Baseline_Cumulative_Hazard.csv",5)`

Table \@ref(tab:IV-Five) shows the results from the internal validation in the Five-State Model.


```{r IV-Five,echo=F}
res_IV <- list_table_Valid("data/Dev_Paper_Validation.csv",5,F)
res_IV[[1]]
```


Table \@ref(tab:EV-Five) shows the results from the external validation in the Five-State Model.

```{r EV-Five,echo=F}
res_EV <- list_table_Valid("data/Dev_Paper_Validation.csv",5,T)
res_EV[[1]]
```

```{r Five-Valid-Slope, echo=F}
full_join(rename(res_IV[[2]],Internal=Slope),
          rename(res_EV[[2]],External=Slope),
          by="Time") %>%
  to_kable(caption="Calibration Slope results for both the External and Internal Validation for the Five-State Model",align="rr",row_names="Time",numeric_cols=2:3,col_widths=rep("5cm",3))
```





