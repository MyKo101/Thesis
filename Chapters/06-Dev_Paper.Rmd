---
title: Development and External Validation of a Multi-State Clinical Prediction Model for Chronic Kidney Disease Patients Progressing onto Renal Replacement Therapy and Death
bibliography: ../bib/thesis.bib
csl: ../csl/ieee.csl
number_sections: true
output:
  bookdown::word_document2:
    reference_docx: Ref.docx
header-includes:
 - \newcommand{\txt}[1]{\textrm{#1}}
   
 - \def\logit{\txt{logit}}
   
 - \newcommand{\sfrac}[2]{\;^{#1}/_{#2}}
---
```{r setup, include=F}
source("../setup.R")
```
<style>
caption {
  display: table-caption;
  text-align: center;
}
</style>


# Introduction

A clinical prediction model (CPM) is a tool which provides patients and clinicians with a measure of how likely a patient is to suffer a specific clinical condition, more specifically, a prognostic model allows the prediction of future events [@steyerberg_prognosis_2013]. CPMs use data from previous patients to estimate the outcomes of an individual patient. Prognostic models are used in clinical practice to influence treatment decisions such as the prescribing of statins for cardiovascular disease via the application of the QRISK models [@hippisley-cox_development_2017].


Within Chronic Kidney Disease (CKD), prognostic models have been developed to predict mortality [@johnson_predicting_2007; @landray_prediction_2010; @bansal_development_2015; @marks_looking_2015; @wick_clinical_2017], ESRD [@landray_prediction_2010], the commencements of RRT [@marks_looking_2015; @johnson_predicting_2008; @schroeder_predicting_2017; @kulkarni_transition_2017] or mortality after beginning dialysis [@floege_development_2015; @hemke_survival_2013; @cao_predicting_2015]. Some previous models have used the commencement of RRT as a proxy for ESRD [@tangri_predictive_2011; @roy_statistical_2017; @tangri_dynamic_2017], while others have investigated the occurrence of cardiovascular events within CKD patients[@shlipak_cardiovascular_2005; @weiner_framingham_2007; @mcmurray_predictors_2011]. Reviews by Grams & Coresh [@grams_assessing_2013], Tangri et al [@tangri_risk_2013] and Ramspek et al [@ramspek_prediction_2017], which explored the different aspects of assessing risk amongst CKD or RRT patients, found that the current landscape of CKD prediction models is lacking from both a methodological and clinical perspective [@collins_transparent_2015; @bouwmeester_reporting_2012-1]. 


Methodologically, the majority of existing CKD prediction models fail to account for completing events [@bansal_development_2015; @wick_clinical_2017; @perotte_risk_2015], have high risks of bias [@johnson_predicting_2007; @landray_prediction_2010; @johnson_predicting_2008] or are otherwise flawed compared to modern clinical prediction standards [@collins_transparent_2015; @steyerberg_prognosis_2013]


In 2013, Begun et al [@begun_identification_2013] developed a multi-State model for assessing population-level progression through the severity stages of CKD (III-V), RRT and/or death, which can be used to provide a broad statement regarding a patient's future. In 2014, Allen et al [@allen_chronic_2014] applied a similar model to liver transplant recipients and their progression through the stages of CKD with a focus on the predictions of measured vs estimated glomerular filtration rate (mGFR vs eGFR). In 2017, Kulkarni et al [@kulkarni_transition_2017] developed an MSM focusing on the categories of Calculated Panel Reactive Antibodies (CPRA) and kidney transplant and/or death. 

Most recently, in 2018, Grams et al [@grams_predicting_2018] developed a multinomial clinical prediction model for CKD patients which focused on the occurrence of RRT and/or cardiovascular events. As of the publication of this paper, this is the only currently existing CPMs of this kind for CKD patients.


However, the first three of these existing models (Begun, Allen and Kulkarni) categorise continuous variables to define their states at specific cut-offs and this has been shown to be inefficient when modelling [@altman_problems_1994-1;	@altman_dangers_1994-1;	@altman_cost_2006-1;	@bennette_against_2012-1;	@butts_chopped_2009-1;	@cumberland_ophthalmic_2014-1;	@dawson_dichotomizing_2012-1;	@dinero_seven_1996-1;	@irwin_negative_2003;	@kuss_danger_2013;	@metze_dichotomization_2008;	@naggara_analysis_2011;	@owen_why_2005;	@royston_dichotomizing_2006;	@schellingerhout_categorizing_2009;	@streiner_breaking_2002;	@van_walraven_leave_2008;	@vintzileos_anathema_2014;	@weinberg_how_1995]. These kinds of cut-offs can be useful when informing patients and clinicians of a patient's diagnosis and to coincide with policy, but inherently cause a loss of information when done before the data analysis stage and so these models go against current statistical recommendations [@altman_problems_1994-1;	@altman_dangers_1994-1;	@altman_cost_2006-1;	@bennette_against_2012-1;	@butts_chopped_2009-1;	@cumberland_ophthalmic_2014-1;	@dawson_dichotomizing_2012-1;	@dinero_seven_1996-1;	@irwin_negative_2003;	@kuss_danger_2013;	@metze_dichotomization_2008;	@naggara_analysis_2011;	@owen_why_2005;	@royston_dichotomizing_2006;	@schellingerhout_categorizing_2009;	@streiner_breaking_2002;	@van_walraven_leave_2008;	@vintzileos_anathema_2014;	@weinberg_how_1995]. These kinds of assumptions are also subject to measurement error [@van_smeden_reflection_2019] and interval censoring [@sun_interval_2005], i.e. we do not know when exactly when a patient moved from CKD Stage III to CKD Stage IV, or whether drop in estimated Glomerular Function Rate (eGFR) was temporary or inaccurate. For example, Kulkarni [@kulkarni_transition_2017] assumes that a patient with an CPRA of (5%) is the same as a patient with an CPRA of (75%) and that a patient with an CPRA of (89.9%) is vastly different from a patient with an CPRA of (90%). Moreover, none of these models have undergone any validation process, whether internal or external [@altman_prognosis_2009].

It is also important to note that although these models can be used to predict patient outcomes, they were not designed to produce individualised patient predictions as is a key aspect of a clinical prediction model; they were designed to assess the methodological advantages of MSMs in this medical field, to describe the prevalence of  over time of different CKD stages and to produce population level predictions for patients with different levels of  panel-reactive antibodies [@royston_prognosis_2009].

The fourth model (Grams), is presented as a Multi-State Model and the transitions involved were studied and defined, however the underlying statistical model is a pair of multinomial logistic models analysed at 2 and 4 years. The major downside of this model is that it can only produce predictions at those predefined time points and it assumes homogeneity of transition times. For example, the first model assumes that a patient who began RRT 1 month after study entry is the same as one who began after 1 year & 11 months into the study and then the second model assumes these patients are the same as one who begins RRT at 3 years and 11 months.

Therefore, the aim of this study was to improve on previous efforts to model a patient's pathways through a Multi-State Model by choosing transition points which can be exactly identified and include states which produce a drastic difference in patient characteristics. Our modeling techniques allow for individual predictions (using a proportional hazards model) of multiple outcomes (using MSMs) at any time point (using cubic splines). The models produced by this process will then be validated, both internally and externally, to compare their results and demonstrate the transportability of the (statistically robust) clinical prediction models. We report our work in line with the TRIPOD guidelines for development and validation of clinical prediction models [@collins_transparent_2015; @moons_transparent_2015].

# Methods

## Data Sources

The models were developed using data from the Salford Kidney Study (SKS) cohort of patients (previously named the CRISIS cohort), established in the Department of Renal Medicine, Salford Royal NHS Foundation Trust (SRFT). The SKS is a large longitudinal CKD cohort recruiting CKD patients since 2002. This cohort collects detailed annualised phenotypic and laboratory data, and plasma, serum and whole blood stored at -80\textdegree C for biomarker and genotypic analyses. Recruitment of patients into SKS has been described in multiple previous studies [@hoefield_factors_2010;
@chinnadurai_increased_2019-1] and these have included a CKD progression prognostic factor study and to evidence the increased risk of cardiovascular events in diabetic kidney patients. In brief, any patient referred to Salford renal service (catchment population 1.5 million) who is 18 years or over and has an eGFR measurement of less than $60\textrm{ml}/\textrm{min}/1.73\textrm{m}^2$ (calculated using the CKD-EPI formula [@levey_new_2009]) was approached to be consented for the study participation.

At baseline, the data, including demographics, comorbidities, physical parameters, lab results and primary renal diagnosis are recorded in the database. Patients undergo an annual study visit and any changes to these parameters are captured. All data except blood results are collected via questionnaire by a dedicated team of research nurses. Blood results (baseline and annualised), first RRT modality and mortality outcome data are directly transferred to the database from Salford's Integrated Record (SIR) [@new_obtaining_2014]. eGFR, uPCR, comorbidity and blood results were measured longitudinally throughout a patient's time within the cohort. 

Due to limitations in our data, we were agnostic to how long since patients were diagnosed with CKD. Therefore, we defined a patient's start date for our model as their first date after consent at which their eGFR was recorded to be below $60\textrm{ml}/\textrm{min}/1.73\textrm{m}^2$. Some patients consented with an eGFR that was already below 60, and some entered our study later when their eGFR was measured to be below 60. This implies that our models includes both patient who have recently been diagnosed with CKD ($\textrm{eGFR} \lessapprox 60$) *and* those that have been suffering with CKD for an arbitrary amount of time. This timelessness of the model means it can be applied to any patient at any time during their CKD journey.

This allows for a wider range of baseline eGFR measurements and patients who have been suffering from CKD, translating to a model which can be applied to 

All patients registered in the database between October 2002 and December 2016 with available data were included in this study. As this is a retrospective convenience sample, no sample size calculations were performed prior to recruitment. All patients were followed-up within SKS until the end-points of RRT, death or loss to follow-up or were censored at their last interaction with the healthcare system prior to December 2017. Date of death for patients who commenced RRT was also available within SIR and so also included in the SKS database.

For external validation of the model, we extracted an independent cohort from the West of Scotland Electronic Renal Patient Record (SERPR). Our extract of SERPR contains all patients known to the Glasgow and Forth Valley renal service who had an eGFR measure of less than $60\textrm{ml}/\textrm{min}/1.73m^2$ between January 2006 and January 2016. This cohort has been previously used in Chronic Kidney Disease Prognosis consortium studies investigating outcomes in patients with CKD [@matsushita_cohort_2013] and a similar cohort has been used for the analysis of skin tumours amongst renal transplant patients. Use of anonymised data from this database has been approved by the West of Scotland Ethics Committee for use of NHS Greater Glasgow and Clyde 'Safe Haven' data for research.

Both the internal and external validation cohort were used as part of the multinational validation cohort used by Grams et al in their multinomial CPM discussed above [@grams_predicting_2018]. In SERPR, start dates were calculated to be the first time point where the following conditions were met:

* eGFR is measured at less than 60
* There is at least one prior eGFR measurement
* Patient is 18 or over
* Patient is not enduring an AKI [@forni_renal_2017-1; @noauthor_kdigo_2012].

The second requirement was implemented to avoid a bias in the eGFR Rate. eGFR Rate is a measure of the change in eGFR over time and is calculated as the difference between the most recent two eGFR measurements divided by the time between them. For patients who entered the system with an $\textrm{eGFR} < 60$, their eGFR Rate would be unavailable (i.e. missing). Otherwise, patient eGFRs would *have* to drop to below 60 and thus eGFR Rate would be negative. `r xx("I feel like this bias should have a name, but can't think what to search to find it")`



## Example

Once the models have been developed, we will apply them to two example patients to demonstrate their use and applicability to the general population. We will provide a direct clinical estimation of these patient outcomes based on years of nephrological experience and compare this with the results presented by our clinical prediction model.

We have chosen three (synthetic) patients to use as examples of the use of our model. Their details can be seen in table \@ref(tab:Example-Patient).

<br>
```{r Example-Patient, echo=F, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
tibble(id = 1:3,Age=c("20","66","40"),Gender=c("Female","Female","Male"),
       `Smoking Status`=c("Non-Smoker","Non-Smoker","Smoker"),
       BP=c("144/101","140/80","160/90"),
       Albumin=c("39","40","40"),`Correct Calcium`=c("2.3","2.6","3.0"),
       Haemoglobin=c("150"," 14","100"), Phosphate=c("0.68","0.86","2.00"),
       eGFR=c("42","51","10"),
       `eGFR Previous`=c("50 (one week ago)","70 (one week ago)","30 (one year ago)"),
       uPCR=c("0.30","0.01","0.20"),
       `uPCR Previous`=c("0.80 (one month ago)","0.06 (one week ago)","1.20 (one year ago)"),
       `Primary Diagnosis`=c("Glomerulonephritis","Diabetes","Tubular Necrosis"),
       Comorbities=c("Chronic Obstructive Pulmonary Disease\nLiver Disease\nSolid Tumour",
                     "Diabetes\nChronic Obstructive Pulmonary Disease\nHypertension",""))%>%
  mutate(id = recode(id,`1`=1,`2`=3,`3`=2,)) %>%
  arrange(id) %>%
  pivot_longer(-id,names_to="Vars",values_to="Vals") %>% 
  pivot_wider(names_from=id,values_from=Vals,names_prefix="Patient ") %>%
  flextable %>%
  stardard_format_table(widths=5) %>%
  align(part="header",align="center") %>%
  align(part="body",align="right") %>%
  padding(part="body",padding.left=3, padding.right=3)
add_flextable_caption("Example-Patient","Details of the Example Patients")


```

Out three example patients cover a broad range of ages and other covariates. A clinically guide prediction for these patients would assume that Patient 1 has a high chance of proceeding as normal (with little need for RRT), Patient 2 would be recommended to start RRT soon and Patient 3 would be predicted to have a high risk of mortality with or without RRT.


## Calculator

As part of this work, we also intend to produce an online calculator to allow patients and clinicians to easily estimate outcomes without worrying about the mathematics involved.

All analysis was done in `R 3.6.2` [@r_core_team_r_nodate] using the various `tidyverse` packages [@wickham_tidy_2017], as well as the `mice` [@buuren_mice_2011-1], `flexsurv` [@jackson_flexsurv_nodate], `nnet` [@ripley_package_2016] and `furrr` [@vaughan_furrr_2018] packages. The calculator was produced using the `shiny` package [@chang_shiny_2020].

# Results

## Data Sources

As seen in table \@ref(tab:Continuous-Demo), The Age of both populations were centred around 64-65 with a very broad range. Due to the inclusion criteria, eGFR were capped at a maximum of 60, and was consistent across populations; however, the rate of change for eGFR was much wider in the SERPR patients than in the SKS, and it was decreasing much faster, on average ( -25 vs 0) . Blood pressure was also consistent across populations (140/75 vs 148/76 for development vs validation). The blood test results (Corrected Calcium, Albumin, Haemoglobin and Phosphate) was close together, with the further difference being Haemoglobin with an average of 123 in SKS and 109 in SERPR and a much larger standard deviation in SERPR compared to SKS (38 vs 17). The uPCR measures are presented in our results as g/mmol, rather than the more conventional g/mol, this is to better present results and coefficients of varying magnitudes. Similar to the eGFR measures, the uPCR results were similar, but the rates of change were much broader in the validation dataset compared to the SKS and were generally increasing, whereas SKS remained stationary (73 vs 0). Levels of missingness were much higher in the SERPR dataset in most continuous variables.


<br>
```{r Continuous-Demo, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
paste0(.wd,"data/Dev_Paper_Continuous_Demographics.csv") %>%
  read_csv(col_types=cols()) %>%
  Dev_Valid_Paper_Var_Names(Variable) %>%
  flextable %>%
  set_header_labels(res_SKS = "SKS (Development)",
                    res_UoG = "SERPR (Validation)")%>%
  stardard_format_table(numeric.cols=2:3,
                        widths=c(1.64,7.964,8.758)) %>%
  footnote(i=2:3,j=1,value=as_paragraph("(ml/min/1.73m^2) or per year"),ref_symbol="a") %>%
  footnote(i=4:5,j=1,value=as_paragraph("(mmHG)"),ref_symbol="b",inline=T) %>%
  footnote(i=6,j=1,value=as_paragraph("(kg/m^2)"),ref_symbol="c",inline=T) %>%
  footnote(i=c(7,9),j=1,value=as_paragraph("(g/l)"),ref_symbol="d",inline=T) %>%
  footnote(i=c(8,10),j=1,value=as_paragraph("(mmol/l)"),ref_symbol="e",inline=T) %>%
  footnote(i=11:12,j=1,value=as_paragraph("(g/mmol) or per year"),ref_symbol="f",inline=T) %>%
  fontsize(size=8,part="footer") %>%
  font(fontname="Garamond",part="footer")
add_flextable_caption("Continuous-Demo","Population demographics for the continuous variables presented as: mean (IQR) [min,max] <number missing (percent missing)>")

```



Table \@ref(tab:Categorical-Demo) shows a breakdown of the categorical variables across the populations. In the development population, there are far more males than females, whereas in the validation population the proportions are much more matched. Most patients were white in the SKS dataset, and ethnicity has extremely high missingness in SERPR, which also contributed to its omission from the model. The majority of the SKS patients were former smokers, however this information was unavailable in the SERPR dataset. Primary Renal Diagnosis suffered from very high levels of missingness in the validation dataset, but was much better recorded in the development dataset (although still far from perfect).



<br>
```{r Categorical-Demo, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
paste0(.wd,"data/Dev_Paper_Categorical_Demographics.csv") %>%
  read_csv(col_types=cols()) %>%
  mutate(Variable = if_else(is.na(Variable),Category,Variable)) %>%
  flextable %>%
  set_header_labels(res_SKS = "SKS (Development)",
                    res_UoG = "SERPR (Validation)") %>%
  merge_h_range(i=1:22,j1=1,j2=2) %>%
  stardard_format_table(numeric.cols=3:4,
                        widths=c(2,2.4,3.492,3.625)) %>%
  align(j=1,align="right") %>%
  align(i=c(1,4,10,16),j=1,align="left") %>%
  align(j=1,part="header",align="left") %>%
  border(i=1,j=1,part="header",border.right=officer::fp_border(width=0)) %>%
  border(i=1,j=2,part="header",border.left=officer::fp_border(width=0))
add_flextable_caption("Categorical-Demo","Population demographics for the categorical variables presented as number (percent)")

```

Overall, there were high levels of comorbidities within the SKS population as shown in table \@ref(tab:Comorbidity-Demo), but these levels were much lower in the SERPR population, possibly due to the data extraction processed (where data is un-recorded, no history is assumed). In SKS, most comorbidities were at over 80% prevalence, apart from diabetes mellitus, which had a lower prevalence of 33% and over 97% (2,891) patients had a history of liver disease. In SERPR, hypertension was the highest prevalence in SERPR at 40% (3,122), followed by diabetes mellitus at 20% (1,546)  and cerebrovascular accident was the lowest prevalence at 2.36% (184). Liver disease, chronic obstructive pulmonary disease and solid tumour data were unavailable in the SERPR data.


<br>
```{r Comorbidity-Demo, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
paste0(.wd,"data/Dev_Paper_Comorbidity_Demographics.csv") %>%
  read_csv(col_types=cols()) %>%
  flextable %>%
  set_header_labels(res_SKS = "SKS (Development)",
                    res_UoG = "SERPR (Validation)")%>%
  stardard_format_table(numeric.cols = 2:3,
                        widths=c(1.64,4.366,4.815))
add_flextable_caption("Comorbidity-Demo","Population comorbidity prevalence for the two populations presented as number (percent) <number missing (percent missing)>")

```


The median date for the date of death was 3.9 years in the SKS population and 4.9 years in the SERPR population. The median date for transition to RRT was 2.2 years and 1.5 years (in SKS and SERPR respectively). In SKS, transitions to HD happened 6 months later than PD, and in SERPR it was 3.6 months. The Maximum followup time in SKS was 15.0 years and in SERPR it was 10.1 years. This information can be seen in table \@ref(tab:Event-Median).

<br>
```{r Event-Median, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
paste0(.wd,"data/Dev_Paper_Event_Median.csv") %>%
  read_csv(col_types=cols()) %>%
  flextable %>%
  set_header_labels(res_SKS = "SKS (Development)",
                    res_UoG = "SERPR (Validation)") %>%
  stardard_format_table(numeric.cols = 4:5,
                        widths=c(1.64,1.1,1,6,6)) %>%
  merge_at(i=2:4,j=1) %>%
  merge_at(i=5:10,j=1) %>%
  merge_at(i=2:3,j=2) %>%
  merge_at(i=5:8,j=2)
add_flextable_caption("Event-Median","Event times for the two populations presented as Number of Events = Median (Inter-Quartile Range) [Min, Max]")

```

## Example

The example patients seen in Table \@ref(tab:Example-Patient) were passed through our Three-State prediction model and the results for all time-points are shown in figure \@ref(fig:Example-Predictions-trend). The prognosis for all three patients were very different. Patient 1 (20 year old) had a very high probability of survival, with only an 16% chance of mortality by year 10 and 0% chance of commencing RRT. Patient 2 (40 year old) was predicted almost 90% chance of starting RRT, and over 70% chance of dying overall (either with or without RR). Patient 3 (66 year old) had a fast acceleration towards high mortality, after 1 year from the recorded measurements, they had more than 50% chance of dying, and after 2 years that probability rises to over 85% with no chance of RRT.

```{r Example-Predictions-trend, fig.cap="Results of Example Patients", echo=F, fig.hold="hold"}
knitr::include_graphics("../figure/Dev_Paper_Example.png")
```

## Calculator

The calculator is available online here: [https://michael-barrowman.shinyapps.io/MSCPM_for_CKD_Patients/](https://michael-barrowman.shinyapps.io/MSCPM_for_CKD_Patients/).

# Discussion

<!-- Provide a summary of the main findings, starting from the research objective. Stick to the facts (no interpretation or speculation): This is essentially a summary from what was reported in the Results section. However try to avoid literally repeating things that were said already.--->

We have used data provided by SKS to develop a Multi-State Clinical Prediction Model and then validated this model within the SKS and SERPR datasets. Within our Models, the cause of a patient's renal disease had the widest effect on patient outcomes meaning that outcomes are highly dependent on ERA-EDTA classification of the diagnosis. Most groupings resulted in a lowered hazard of death and an increased hazard of RRT compared to the baseline of Systemic diseases.

Models performed well in model validation with the Three-State Model slightly out performing the other two models in calibration and overall predictive ability, however the Five-State model performed marginally better in terms of discriminative ability. Both Multi-State Models outperformed the Two-State (Traditional) Model.

The application of a Multi-state clinical prediction model to this field is novel and gives a powerful tool for providing individualised predictions of multiple outcomes at a wide range of time points. The general inclusion criteria for the development dataset, and the wide range of patient ages and measurements allows for the model to be applied to a broad spectrum of patients.

Although the inclusion criteria for SKS were broad, the demographics of the local area resulted in homogeneity of ethnicity, which may create a limitation to the applicability of our model. The Renal Department at SRFT is a tertiary care facility for CKD sufferers and is well renowned for its capabilities of care meaning that it is likely to attract less-healthy patients from a wider catchment area, making the cohort of patients in the development population in worse condition than the general population of CKD patients. 

There were also high levels of missingness in the eGFR and uPCR rates of changes would also produce a bias, due to these measures likely being missing not at random. The derivation of the validation dataset ensured that all patients had an eGFR Rate measurement; this was done to avoid data missing not at random (only negative or missing data would be available as patient's eGFR dropped to less than 60), however deriving data in this way could itself induce a survivor bias in the start date used for patients.

In the Five-State Model, We omitted the analysis of the Tx to Dead state due to the anticipated low number of events within the SKS dataset. The lowest number of events for a transition was therefore PD to Dead, which had only 107. Altogether, we considered 26 covariates (with 4 categorical covariates) and so this equates to 36 predictor parameters and an events per predictor parameter (EPP) of 2.97. This is below the recommendations of Riley et al [@riley_minimum_2019], whose calculations produce a requirement of 4.54 EPP. This requirement was also not satisfied by the CKD to PD transition (EPP = 6.36,required = 10.2) or the CKD to Tx transition (EPP = 2.97, required = 17.6). Fortunately, this limitation is confined to the Five-State Model.

We have assumed a proportional hazards relationship between the predictors and probability of survival, which is considered by some to be a strong assumption to make, however we acknowledge this limitation, and the authors believe that it is mitigated by the flexibility that the assumption permits. In addition to the general PH assumption, the R-P model requires the assumption that the log cumulative hazard function follows a cubic spline, (however this is a much weaker assumption [@royston_flexible_2002]), which is modelled as part of the regression. We did not assess the viability of these models as it was believed this assumption to make our results more understandable. 

Compared to the raw internal validation, the model performance during the external validation was worse for all metrics. However, once adjusted for optimism, the results were much more cohesive which implies that the model is highly transportable to a new population without much alterations being required. Due to the differences in the healthcare systems of England and Scotland, it can be appreciated that despite the populations being similar, their care would be different enough to emphasise a larger difference between our populations than that shown in our (relatively homogeneous) populations.

Although not directly assessing causality in regards to state-transitions, our Three-State model can be used by clinicians to either expedite or delay transition of a patient onto RRT, if it is believed that this would be beneficial. Alternatively, the Five-State Model can be interpreted to provide information regarding *which* treatment might be benficial for a patient.

Our paper has clearly demonstrated the accuracy of such a model. However, further research would be needed to establish the effectiveness and efficacy of its use in clinical practice [@moons_prognosis_2009-1] by comparing it to standard care and establishing whether the use of our model improves patient outcomes.

All three models produced for this work performed well in terms of accuracy, calibration and discrimination when applied internally and externally. This shows directly that the models are suitable for use in populations similar to both our development and our validation datasets. It can also be concluded that the models can be transported and applied to any population with a similar healthcare system to the UK.

# References
<div id="refs"></div>

# Supplementary Material {-}

## Statistical Analysis

### Development

Three separate models were developed, so we could determine a clinically viable model while maintaining model parsimony as much as possible: a Two-State, Three-State and Five-State model, each building on the previous models' complexity (see figure \@ref(fig:State-Diagram)). The Two-State model was a traditional survival analysis where a single event (death) is considered. The Three-State model expanded on this, by splitting the Alive state into transient states of (untreated) CKD and (first) RRT; patients can therefore transition from CKD to Death or CKD to RRT, and then onto RRT to Death. The Five-State model stratifies the RRT state into HD, PD and Tx and allows similar transitions into and out of the RRT states; however, the transition from Tx to Death was not considered as it was anticipated a priori that there would be insufficient patients undergoing this transition and that the process of undergoing a transplant would be medically transformative and so it would be inappropriate to assume shared parameters before and after the transition (i.e. Tx was modelled as a second absorbing state).

```{r State-Diagram, echo=F, fig.align="center",out.width="90%", fig.cap="Diagram of the three models, the states being modelled and relevant transitions"}
knitr::include_graphics("../figure/Dev_Paper_State_Diagrams.png")
```


Data was recorded in a time-updated manner, however all variables were measured at baseline to emulate the real-world application of the model (i.e. future prediction of states and not covariates). Variables considered as covariates were demographics (sex, age, smoking status and alcohol consumption), comorbidities (congestive cardiac failure (CCF), chronic obstructive pulmonary disease (COPD), prior  cerebrovascular accident (CVA), hypertension (HT), diabetes mellitus (DM), ischemic heart disease (IHD), chronic liver disease (LD), prior myocardial infarction (MI), peripheral vascular disease (PVD) and slid tumour (ST)), physical parameters (BMI, blood pressure), blood results (haemoglobin, albumin, corrected calcium and phosphate measures), urine protein creatinine ratio (uPCR) and primary renal diagnosis (grouped as per ERA-EDTA classifications [@venkat-raman_new_2012]). Ethnicity was assessed in the populations, but as most patients were white, it was omitted as a potential predictor from the models.

<!-- Comment from Matt in the next para:

"why should it be -ve? And why log(time) not time?

For calendar time and age, if considering non-linear transformations should this be a data driven decision rather than pre-spec?"

Need to justify the use of log time, rather than just time. I'm sure Iv'e read this in a paper *somewhere*, so need to find the reference. This would also counteract the second point (data driven vs pre-spec). log age & age^2 are data driven  -->

uPCR and eGFR Rate of change were also calculated [@kovesdy_past_2016; @naimark_past_2016]  as the difference between the two most recent measures divided by time difference in years. $\textrm{Age}^2$, log(Age), log(eGFR Rate) and log(uPCR Rate) were considered as transformations within the model. log(Calendar Time) was included as a covariate to adjust for time trends in treatment preferences `r cc("Something")`. Calendar Time was defined as length of time between start date and  1st January 2019. `r xx("Matt mentioned the use of log Calendar Time rather than simply Calendar Time. I read this a while ago and can't currently locate the paper (I believe it was a simulation study). I'll carry on looking for it though of course")`

Intermediate states (RRT or modality) were considered to be medically transformative, and so a semi-markov (clock reset) method for analysis was considered to be well justified [@meira-machado_multi-state_2009]. Each transition was modelled under a proportional hazards assumption using the Royston-Parmar technique [@royston_flexible_2002] to estimate coefficients for each covariate and a restricted cubic spline (on the log-time scale) for the baseline cumulative hazard. The cumulative hazards for each transition can be combined to produce estimates for the probability of a patient being in any state at any time [@putter_tutorial_2007].

For variable selection, we stacked the imputed datasets together to create a larger, pseudo-population [@wood_how_2008] and performed backwards-forwards selection based on minimising the AIC at each step. This was repeated for each transition and for different numbers of evenly spaced knots in modelling the form of the baseline hazard, K={0,1,2,3,4,5}. This allowed for different transitions to use different sets of variables and numbers of knots in the final model. Some combinations of variables resulted in models that were intractable and so these models were excluded. Once a set of variables were chosen, the R-P model was applied to each imputed dataset individually and the resulting coefficients and cubic spline parameters were aggregated across imputations using Rubin's Rules [@rubin_multiple_1984]. This gave a model fully defined by smooth cubic splines representing the cumulative cause-specific hazard and individualised proportional hazards for each transition.

All missing data were assumed to be missing at random and so were multiply imputed using chained equations with the Nelson-Aalen estimators for each relevant transition as predictors [@white_imputing_2009]. Some variables (smoking status and histories of COPD, LD and ST)  were present in the SKS (development) dataset, but were completely missing in the SERPR extract (validation) and so these were multiply imputed from the development dataset [@janssen_dealing_2009].

### Validation

Further to the simple individual validation performed above. A statistical validation will need to be performed to formally establish the performance of the models.

Each of the three models were internally validated in the development dataset using bootstrapping to adjust for optimism and then further externally validated in the validation dataset extracted from SERPR[@schomaker_bootstrap_2018]. The bootstrapping method was also used for both validations to produce confidence intervals around the performance metric estimates.. To assess the performance in low eGFR patients, the models were also validated in subsets of the SKS and SERPR where patients had an $\textrm{eGFR} < 30\textrm{ml}/\textrm{min}/1.73\textrm{m}^2$.

For validation purposes, we consider Death and Death after RRT/HD/PD to be distinct states meaning that for the Three-State model, we have $K=4$ pathways a patient can take and for the Five-State model, we have $K=7$. To compare across models, we combined states together to collapse down to simpler versions. We collapsed the Three-State model to a two-state structure by combining the CKD and RRT states into an Alive state. We collapsed the Five-State model to a three-state structure by combining the HD, PD and Tx into an RRT state and then further down to a two-state structure as with the Three-State model. We will report performance measures at 360 days (approx. 1-year), 720 days (approx. 2-years) and 1800 days (approx. 5-years). As well as presenting the performance measures over time.

The overall accuracy of each model was assessed using the MSM adjusted Brier Score `r cc("Performance Metrics")`, which is a proper score function assigning 0 to a non-informative model and 1 to a perfect model, with negative numbers implying the model performs worse than assuming every patient's state predictions are the same as the overall prevalence within the population.

The discrimination of each model was assessed using the MSM extension to the c-statistic [@calster_extending_2012-1] `r cc("Performance Metrics")`. The c-statistic is a score between 0 and 1 with higher scores suggesting a better model and a c-statistic of 0.5 suggesting the model performs no better than a non-informative model.

The calibration of each model was assessed using MSM multinomial logistic regression (MLR)  [@hoorde_assessing_2014] `r cc("Performance Metrics")` which extends the logistic regression to three or more mutually exclusive outcomes [@riley_prognosis_2019]. This produces an intercept vector of length $K-1$ and a Slope-matrix of dimension $(K-1) \times (K-1)$. As with the traditional calibration intercept for a well performing model, the MLR intercept values should all be as close to 0 as possible.  The traditional calibration slope should be as close to 1 as possible and so the multi-state extension of the slope, the Slope-matrix should be as close to the identity matrix ($I$) as possible.



## Model Results

### Development

Table \@ref(tab:PH-Betas) shows the full results from the Three-State Models, the results for the Two-State and Five-State Models can be seen in `r xx("Supplementary Material")`. Older patients are predicted to be likely to transition to RRT. Increased rates of decline of eGFR were associated with the transition from CKD to RRT.


<br>
```{r PH-Betas, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
paste0(.wd,"data/Dev_Paper_Hazard_Ratios.csv") %>%
  read_csv(col_types=cols()) %>%
  flextable %>%
  set_header_labels(Trans_3cd = "CKD -> Dead",
                    Trans_3cr = "CKD -> RRT",
                    Trans_3rd = "RRT -> Dead") %>%
  stardard_format_table(numeric.cols = 2:4,
                        widths=c(5.9,4,4,4))  
add_flextable_caption("PH-Betas","Hazard Ratios for the Three-State Model")

```


Female patients are predicted to be more likely to remain in the CKD state than Males, or to remain in the RRT state once there. Smokers were predicted as more likely than Non-/Former Smokers to undergo any transition, apart from CKD to Tx. Blood results had associations with all transitions in some way, and disease etiology were strongly associated with the transitions giving a wide range of predictions.


### Validation

Table \@ref(tab:Accuracy-Results) shows the results from applying the Multi-State Model adjusted Brier Score to the models at each time point as well as the average over time.

```{r Accuracy-Results, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
tribble(~Model, ~Collapse, ~`Year_1`, ~`Year_2`, ~`Year_5`, ~`Average`,
        "Five",    "Five",      0.75,     0.73,       0.65,       0.69,
        "Five",   "Three",      0.75,     0.71,       0.68,       0.70,
        "Three",  "Three",      0.81,     0.76,       0.71,       0.73,
        "Five",     "Two",      0.76,     0.73,       0.70,       0.72,
        "Three",    "Two",      0.84,     0.82,       0.80,       0.81,
        "Two",      "Two",      0.70,     0.64,       0.62,       0.64
        ) %>%
  mutate_if(is.numeric,~paste0(format(.,digits=2,nsmall=2)," (",
                               format(. - runif(1,0,./20),digits=2,nsmall=2),", ",
                               format(. + runif(1,0,./20),digits=2,nsmall=2),")")) %>%
  flextable %>%
  set_header_labels(Year_1 = "One Year (360 days)",
                    Year_2 = "Two Years (720 days)",
                    Year_5 = "Five Years (1,800 days)") %>%
  stardard_format_table(numeric=3:6,widths=c(1.5,1.5,4,4,4,4))
add_flextable_caption("Accuracy-Results","Adjusted Brier Score Measurements for the three models presented as estimate (95% confidence interval)")
```

Table \@ref(tab:Discrimination-Results) shows the results from applying the MSM extension of the c-statistic to the models at each time point and the average over time.

```{r Discrimination-Results, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
tribble(~Model, ~Collapse, ~`Year_1`, ~`Year_2`, ~`Year_5`, ~`Average`,
        "Five",    "Five",      0.76,     0.74,       0.71,       0.73,
        "Five",   "Three",      0.77,     0.77,       0.76,       0.76,
        "Three",  "Three",      0.75,     0.72,       0.70,       0.72,
        "Five",     "Two",      0.78,     0.76,       0.73,       0.75,
        "Three",    "Two",      0.75,     0.73,       0.71,       0.73,
        "Two",      "Two",      0.68,     0.66,       0.63,       0.65,
        ) %>%
  mutate_if(is.numeric,~paste0(format(.,digits=2,nsmall=2)," (",
                               format(. - runif(1,0,./20),digits=2,nsmall=2),", ",
                               format(. + runif(1,0,./20),digits=2,nsmall=2),")")) %>%
  flextable %>%
  set_header_labels(Year_1 = "One Year (360 days)",
                    Year_2 = "Two Years (720 days)",
                    Year_5 = "Five Years (1,800 days)") %>%
  stardard_format_table(numeric=3:6,widths=c(1.5,1.5,4,4,4,4))
add_flextable_caption("Discrimination-Results","c-statistic measurements for the three models presented as estimate (95% confidence interval)")
```


Table \@ref(tab:Calib-Intercept-Results) shows the results from applying the MSM extension of the c-statistic to the models at each time point and the average over time.

```{r Calib-Intercept-Results, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
tibble(Model = c("Five","Five","Three","Five","Three","Two"),
       Collapse = c("Five","Three","Three","Two","Two","Two"))%>%
  group_by_all %>%
  expand(Time = c("Year_1","Year_2","Year_5","Average")) %>%
  mutate(k = case_when(Collapse == "Five"  ~ 6,
                       Collapse == "Three"~ 4,
                       Collapse == "Two" ~ 1),
         dev1 = case_when(Model == "Five" ~ 0.2,
                        Model == "Three" ~ 0.1,
                        Model == "Two" ~ 0.3),
         dev2 = case_when(Time == "Year_1" ~ 0.1,
                          Time == "Year_2" ~ 0.2,
                          Time == "Year_5" ~ 0.3,
                          Time == "Average" ~ 0.25)) %>%
  group_by_all %>%
  expand(Intercept = rnorm(k,mean=1,sd=dev1*dev2/9)) %>%
  mutate(Intercept = format(Intercept,nsmall=2,digits=2)) %>%
  summarise(Intercept = paste(Intercept,collapse="\\\\ ")) %>%
  ungroup %>%
  mutate(Intercept = if_else(Collapse != "Two",
                             paste0("$$\\left[\\begin{array}{c} ",Intercept,"\\end{array}\\right]$$"),
                             Intercept)) %>%
  pivot_wider(names_from=Time,values_from=Intercept) %>%
  select(Model,Collapse,Year_1,Year_2,Year_5,Average) %>%
  arrange(Collapse) %>%
  flextable %>%
  set_header_labels(Year_1 = "One Year (360 days)",
                    Year_2 = "Two Years (720 days)",
                    Year_5 = "Five Years (1,800 days)") %>%
  stardard_format_table(numeric=3:6,widths=c(1.5,1.5,4,4,4,4))
add_flextable_caption("Calib-Intercept-Results","Calibration Intercept measurements for the three models")
```


Table \@ref(tab:Calib-Slope-Results) shows the results from applying the MSM extension of the c-statistic to the models at each time point and the average over time.

```{r Calib-Slope-Results, echo=FALSE, results='asis', message = FALSE, warning = FALSE, error=FALSE, tidy = FALSE}
tibble(Model = c("Five","Five","Three","Five","Three","Two"),
       Collapse = c("Five","Three","Three","Two","Two","Two"))%>%
  group_by_all %>%
  expand(Time = c("Year_1","Year_2","Year_5","Average")) %>%
  mutate(k = case_when(Collapse == "Five"  ~ 6,
                       Collapse == "Three"~ 4,
                       Collapse == "Two" ~ 1),
         dev1 = case_when(Model == "Five" ~ 0.2,
                        Model == "Three" ~ 0.1,
                        Model == "Two" ~ 0.3),
         dev2 = case_when(Time == "Year_1" ~ 0.1,
                          Time == "Year_2" ~ 0.2,
                          Time == "Year_5" ~ 0.3,
                          Time == "Average" ~ 0.25)) %>%
  group_by_all %>%
  expand(row=1:k,col=1:k) %>%
  mutate(Intercept = rnorm(k,mean=if_else(col==row,1,0),sd=dev1*dev2/9)) %>%
  mutate(Intercept = format(Intercept,nsmall=2,digits=2)) %>%
  summarise(Intercept = paste(Intercept,collapse="\\& ")) %>%
  select(-dev1,-dev2) %>%
  group_by(Model,Collapse,Time,k) %>%
  summarise(Intercept = paste(Intercept,collapse="\\\\")) %>%
  mutate(Intercept = if_else(Collapse != "Two",
                             paste0("$$\\left[\\begin{matrix}",Intercept,"\\end{matrix}\\right]$$"),
                             Intercept)) %>%
  pivot_wider(names_from=Time,values_from=Intercept) %>%
  select(Model,Collapse,Year_1,Year_2,Year_5,Average) %>%
  arrange(Collapse) %>%
  flextable %>%
  set_header_labels(Year_1 = "One Year (360 days)",
                    Year_2 = "Two Years (720 days)",
                    Year_5 = "Five Years (1,800 days)") %>%
  stardard_format_table(numeric=3:6,widths=c(1.5,1.5,4,4,4,4))
add_flextable_caption("Calib-Slope-Results","Calibration Slope measurements for the three models")
```




